// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  user
}

enum ListStatus {
  watching
  completed
  plan_to_watch
  on_hold
  dropped
}

enum AnimeStatus {
  currently_airing
  finished_airing
  not_yet_aired
}

enum AccessType {
  limited_time
  subscription
  free
}

model User {
  id Int @id @default(autoincrement())

  username  String   @unique
  picture   String?
  role      Role     @default(user)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  email         String?  @unique
  password      String?
  otpCode       String   @map("otp_code")
  otpExpiration DateTime @map("otp_expiration")
  isVerifed     Boolean  @default(false) @map("is_verified")

  googleId        String? @unique @map("google_id")
  malId           String? @unique @map("mal_id")
  malAccessToken  String? @unique @map("mal_access_token")
  malRefreshToken String? @unique @map("mal_refresh_token")

  animeList AnimeList[]

  @@map("users")
}

model AnimeList {
  id              Int  @id @default(autoincrement())
  userId          Int  @map("user_id")
  animeId         Int  @map("anime_id")
  animePlatformId Int? @map("anime_platform_id") // User selected platform

  startDate          DateTime?  @map("start_date")
  finishDate         DateTime?  @map("finish_date")
  progress           Int        @default(0)
  score              Int        @default(0)
  episodesDifference Int        @default(0) @map("episodes_difference") // Example: Bstation free user
  status             ListStatus @default(plan_to_watch)
  isSyncedWithMal    Boolean    @default(false)
  updatedAt          DateTime   @updatedAt @map("updated_at")

  user     User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  anime    Anime          @relation(fields: [animeId], references: [id], onDelete: Cascade)
  platform AnimePlatform? @relation(fields: [animePlatformId], references: [id])

  @@unique([userId, animeId])
  @@map("anime_list")
}

model Anime {
  id Int @id @default(autoincrement())

  malId        Int         @unique @map("mal_id")
  updateAt     DateTime    @updatedAt @map("updated_at")
  picture      String
  title        String
  titleID      String?     @map("title_id")
  titleEN      String?     @map("title_en")
  releaseAt    DateTime?   @map("release_at")
  episodeTotal Int         @default(0) @map("episode_total")
  status       AnimeStatus @default(not_yet_aired)

  platforms      AnimePlatform[]
  animeList      AnimeList[]
  animeSchedules AnimeSchedule[]

  @@map("anime")
}

model AnimePlatform {
  id         Int @id @default(autoincrement())
  animeId    Int @map("anime_id")
  platformId Int @map("platform_id")

  link                String     @unique
  accessType          AccessType @map("access_type")
  nextEpisodeAiringAt DateTime   @map("next_episode_airing_at")
  lastEpisodeAiredAt  DateTime?  @map("last_episode_aired_at")
  intervalInDays      Int        @default(7) @map("interval_in_days")
  episodeAired        Int        @default(0) @map("episode_aired")
  isMainPlatform      Boolean    @default(false) @map("is_main_platform")
  isHiatus            Boolean    @default(false) @map("is_hiatus")

  anime     Anime       @relation(fields: [animeId], references: [id], onDelete: Cascade)
  platform  Platform    @relation(fields: [platformId], references: [id], onDelete: Cascade)
  animeList AnimeList[]

  @@unique([platformId, animeId])
  @@map("anime_platform")
}

model Platform {
  id   Int    @id @default(autoincrement())
  name String @unique

  animePlatform AnimePlatform[]

  @@map("platforms")
}

model AnimeSchedule {
  id      Int @id @default(autoincrement())
  animeId Int @map("anime_id")

  status    AnimeStatus
  updateOn  DateTime    @map("update_on")
  isUpdated Boolean     @default(false) @map("is_updated")

  anime Anime @relation(fields: [animeId], references: [id], onDelete: Cascade)

  @@unique([animeId, status])
  @@map("anime_schedules")
}
